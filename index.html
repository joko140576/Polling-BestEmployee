<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Polling Best Employee PT SSI</title>

  <!-- BOOTSTRAP -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- BOOTSTRAP ICONS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <!-- CHART.JS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background: #eef1f7; }
    .page { display: none; } 

    .card-nominator { border-left: 6px solid #0d6efd; background: #f0f6ff; }
    .card-polling { border-left: 6px solid #28a745; background: #e9ffef; }
    .card-hasil { border-left: 6px solid #ffc107; background: #fff8e5; }

    .star { font-size: 28px; cursor: pointer; color: #ccc; transition: 0.2s; }
    .star:hover { transform: scale(1.2); }
    .star.selected { color: #ffbf00; }

    .nav-btn {
      border-radius: 30px;
      padding: 10px 20px;
      font-weight: bold;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }

    #loadingHasil {
      display: none;
      text-align: center;
      padding: 20px 0;
    }

    .loader-spin {
      width: 55px;
      height: 55px;
      border: 7px solid #ddd;
      border-top-color: #ffc107;
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
      margin: auto;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="container py-4 text-center">
    <h1 class="fw-bold">
      <i class="bi bi-award-fill text-warning"></i> Polling The Best Employee
    </h1>
    <p class="text-muted">Aplikasi Polling Employee of The Month PT SSI Jatiwarna.</p>

    <div class="d-flex justify-content-center gap-2 flex-wrap my-3">
      <button class="btn btn-primary nav-btn" onclick="showPage('nominator')">
        <i class="bi bi-person-plus-fill me-1"></i> Nominator
      </button>

      <button class="btn btn-success nav-btn" onclick="showPage('polling')">
        <i class="bi bi-star-half me-1"></i> Polling
      </button>

      <button class="btn btn-warning nav-btn" onclick="showPage('hasil')">
        <i class="bi bi-bar-chart-fill me-1"></i> Hasil
      </button>
    </div>
  </div>

  <!-- PAGE NOMINATOR -->
  <div class="container page" id="nominator">
    <div class="card shadow p-4 card-nominator">
      <h3 class="mb-3"><i class="bi bi-person-lines-fill"></i> Form Nominator</h3>
      <p>Pilih maksimal 3 orang dari masing-masing divisi untuk menjadi Nominator.</p>

      <form id="formNominator">
        <div class="mb-3">
          <label class="form-label fw-bold">Nama Nominator</label>
          <input name="nama" type="text" class="form-control" placeholder="Masukkan Nama" required>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Divisi</label>
          <select name="div" class="form-select" required>
            <option value="">Pilih Divisi</option>
            <option>ina</option><option>frm</option><option>hcc</option>
            <option>plm</option><option>sbd</option><option>mbs</option><option>ops</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Keterangan</label>
          <textarea name="ket" class="form-control" placeholder="Tulis alasan nominasi" required></textarea>
        </div>

        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-save me-1"></i> Simpan Nominator
        </button>
      </form>
    </div>
  </div>

  <!-- PAGE POLLING -->
  <div class="container page" id="polling">
    <div class="card shadow p-4 card-polling">
      <h3 class="mb-3"><i class="bi bi-ui-checks-grid"></i> Polling Penilaian</h3>
      <p class="text-muted">Pilih nama karyawan lalu beri rating 1–5.</p>

      <div class="mb-3">
        <label class="form-label fw-bold">Pilih Divisi</label>
        <select id="myDivision" class="form-select">
          <option value="">--- Pilih Divisi  ---</option>
          <option>ina</option><option>frm</option><option>hcc</option>
          <option>plm</option><option>sbd</option><option>mbs</option><option>ops</option>
        </select>
      </div>

      <div id="listPolling" class="mt-3"></div>

      <button onclick="submitPolling()" class="btn btn-success w-100 mt-3">
        <i class="bi bi-send-check-fill me-1"></i> Submit Polling
      </button>
    </div>
  </div>

  <!-- PAGE HASIL -->
  <div class="container page" id="hasil">
    <div class="card shadow p-4 card-hasil">
      <h3 class="mb-3"><i class="bi bi-trophy-fill text-warning"></i> Top 3 Best Employee</h3>

      <div id="loadingHasil">
        <div class="loader-spin"></div>
        <p class="text-muted mt-2">Memuat data...</p>
      </div>

      <ol id="topHasil" class="fs-5"></ol>

      <hr>
      <h4 class="mb-3"><i class="bi bi-bar-chart-line-fill"></i> Grafik Total Nilai (Top 3)</h4>

      <canvas id="chartHasil" height="140"></canvas>
    </div>
  </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycby7ZUk0VU4LJJ2me150M_OlM4ZHXDwQrzosjii3odCfk2319njnj69udriUYI1_N530/exec";

let nominators = [];
let ratingsMap = {};
let chart = null;

// default: semua page disembunyikan
document.querySelectorAll(".page").forEach(p => p.style.display = "none");

function showPage(id){
  document.querySelectorAll(".page").forEach(p => p.style.display = "none");
  document.getElementById(id).style.display = "block";

  if(id === "polling") loadNominators();
  if(id === "hasil") loadHasil();
}

// SIMPAN NOMINATOR
document.getElementById("formNominator").addEventListener("submit", e => {
  e.preventDefault();
  const nama = e.target.nama.value.trim();
  const div = e.target.div.value.trim();
  const ket = e.target.ket.value.trim();

  if(!nama || !div || !ket){ alert("Lengkapi semua field!"); return; }

  fetch(API_URL, { method:"POST", mode:"no-cors", body:JSON.stringify({ action:"nominator", nama, div, ket }) });
  alert("Nominator berhasil disimpan!");
  e.target.reset();
});

// LOAD NOMINATOR
function loadNominators(){
  fetch(API_URL, {
    method:"POST",
    body: JSON.stringify({ action:"getNominators" })
  })
  .then(r=>r.json())
  .then(data=>{
    nominators = data || [];
    tampilPolling();
  })
  .catch(()=>{
    document.getElementById("listPolling").innerHTML = "<p class='text-muted'>Gagal mengambil data nominator.</p>";
  });
}

// TAMPIL POLLING
document.getElementById("myDivision").addEventListener("change", tampilPolling);

function tampilPolling(){
  const div = document.getElementById("myDivision").value;
  const box = document.getElementById("listPolling");
  box.innerHTML = "";

  if(!div) return;

  const list = nominators.filter(n=>n.div === div);

  if(list.length === 0){
    box.innerHTML = "<p class='text-muted'>Tidak ada nominator di divisi ini.</p>";
    return;
  }

  list.forEach(n=>{
    const item = document.createElement("div");
    item.className = "p-3 mb-3 border rounded bg-light shadow-sm";
    item.dataset.nama = n.nama;
    item.dataset.div = n.div;

    item.innerHTML = `<b class="fs-5"><i class='bi bi-person-fill'></i> ${n.nama}</b><br>`;

    const starsDiv = document.createElement("div");
    starsDiv.className = "mt-2";

    for(let i=1; i<=5; i++){
      let s = document.createElement("span");
      s.textContent = "★";
      s.className = "star me-1";
      s.dataset.value = i;

      s.addEventListener("click", function(){
        setRatingForItem(item, Number(this.dataset.value));
      });

      starsDiv.appendChild(s);
    }

    item.appendChild(starsDiv);
    box.appendChild(item);
  });
}

// SET RATING
function setRatingForItem(item, nilai){
  const nama = item.dataset.nama;
  const div = item.dataset.div;

  ratingsMap[nama] = { nama, div, nilai };
  updateStarsVisual(item, nilai);
}

function updateStarsVisual(item, nilai){
  const stars = item.querySelectorAll(".star");
  stars.forEach((s, idx)=>{ s.classList.toggle("selected", idx < nilai); });
}

// SUBMIT POLLING
function submitPolling(){
  const keys = Object.keys(ratingsMap);
  if(keys.length === 0){ alert("Belum ada rating yang dipilih."); return; }

  keys.forEach(k=>{
    const entry = ratingsMap[k];
    fetch(API_URL, {
      method:"POST",
      mode:"no-cors",
      body: JSON.stringify({
        action:"polling",
        user:"pegawai",
        nama:entry.nama,
        divisi:entry.div,
        nilai:entry.nilai
      })
    });
  });

  alert(`Berhasil mengirim ${keys.length} rating.`);
  ratingsMap = {};
}

// ===================== FIX LOADING + HASIL =====================
function loadHasil() {

  document.getElementById("loadingHasil").style.display = "block";
  document.getElementById("topHasil").style.display = "none";
  document.getElementById("chartHasil").style.display = "none";

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action: "getResults" })
  })
  .then(r => r.json())
  .then(data => {

    document.getElementById("loadingHasil").style.display = "none";
    document.getElementById("topHasil").style.display = "block";
    document.getElementById("chartHasil").style.display = "block";

    const list = document.getElementById("topHasil");
    list.innerHTML = "";

    data.forEach(d => {
      list.innerHTML += `<li>${d.nama} (${d.div}) — total nilai: ${d.total}</li>`;
    });

    drawChart(data);
  })
  .catch(() => {
    document.getElementById("loadingHasil").style.display = "none";
    document.getElementById("topHasil").style.display = "block";
    document.getElementById("topHasil").innerHTML =
      "<li class='text-muted'>Gagal memuat data hasil.</li>";
  });
}

// GAMBAR CHART
function drawChart(data){
  let ctx = document.getElementById("chartHasil").getContext("2d");
  if(chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: data.map(d => d.nama),
      datasets: [{
        label: "Total Nilai",
        data: data.map(d => d.total),
        backgroundColor: "#ffcc00",
        borderColor: "#d4a200",
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true } },
      scales: { y: { beginAtZero: true } }
    }
  });
}
</script>
</body>
</html>
